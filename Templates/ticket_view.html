{% extends 'base.html' %}

{% block title %}Dashboard - MyApp{% endblock %}
{% load static %}
{% load custom_filters %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/ticket_view.css' %}">
<div class="ticket-view">

    <!-- Navigation Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="location.href='{% url 'ticket_with_contact' %}'">
            New Ticket
        </button>    
        <button class="tab" id="graph-button">Graph</button>
    </div>

    <!-- Filter Section -->
    <div class="filter">
        <form id="filter-form" method="get" class="filter-form">
            <select name="assigned" onchange="this.form.submit()">
                <option value="">All Assigned</option>
                {% for assigned in assigned_values %}
                <option value="{{ assigned }}" {% if filters.assigned == assigned %}selected{% endif %}>{{ assigned }}</option>
                {% endfor %}
            </select>
            <select name="status" onchange="this.form.submit()">
                <option value="">All Status</option>
                <option value="Open" {% if filters.status == "Open" %}selected{% endif %}>Open</option>
                <option value="In Progress" {% if filters.status == "In Progress" %}selected{% endif %}>In Progress</option>
                <option value="On Hold" {% if filters.status == "On Hold" %}selected{% endif %}>On Hold</option>
                <option value="Answered" {% if filters.status == "Answered" %}selected{% endif %}>Answered</option>
                <option value="Closed" {% if filters.status == "Closed" %}selected{% endif %}>Closed</option>
            </select>
            <input type="text" name="mobile" placeholder="Mobile" value="{{ filters.mobile }}" oninput="this.form.submit()">
        </form>
    </div>
    
    <!-- Tickets Summary -->
    <div class="ticket-summary">
        <h3>Tickets Summary</h3>
        <div class="summary-items">
            <div class="summary-item">
                <div class="icon" style="background-color: #DFFFEA;">
                    <img src="{% static 'images/openticket.png' %}" alt="Open Tickets">
                </div>
                <div class="text">
                    <h4>{{ ticket_counts.open }}</h4>
                    <p>Open Tickets</p>
                </div>
            </div>
            <div class="summary-item">
                <div class="icon" style="background-color: #E7F3FF;">
                    <img src="{% static 'images/inprogress.png' %}" alt="In Progress">
                </div>
                <div class="text">
                    <h4>{{ ticket_counts.in_progress }}</h4>
                    <p>In Progress</p>
                </div>
            </div>
            <div class="summary-item">
                <div class="icon" style="background-color: #F4F4F4;">
                    <img src="{% static 'images/onhold.png' %}" alt="On Hold">
                </div>
                <div class="text">
                    <h4>{{ ticket_counts.on_hold }}</h4>
                    <p>On Hold</p>
                </div>
            </div>
            <div class="summary-item">
                <div class="icon" style="background-color: #DFF9FF;">
                    <img src="{% static 'images/answered.png' %}" alt="Answered">
                </div>
                <div class="text">
                    <h4>{{ ticket_counts.answered }}</h4>
                    <p>Answered</p>
                </div>
            </div>
            <div class="summary-item">
                <div class="icon" style="background-color: #FFE7E7;">
                    <img src="{% static 'images/closed.png' %}" alt="Closed">
                </div>
                <div class="text">
                    <h4>{{ ticket_counts.closed }}</h4>
                    <p>Closed</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Graph Section (Initially Hidden) -->
    <div id="graph-section" style="display: none; width="100"; height="100";">
        <h3>Tickets Overview</h3>
        <canvas id="ticket-chart" ></canvas>
    </div>

    <!-- Table Section -->
    <div class="table-section">
        <div class="table-controls">
            <a href="{% url 'export_tickets' %}" class="export-btn">Export</a>
        </div>
        <table class="doctors-table">
            <thead>
                <tr>
                    <th>SL NO</th>
                    <th>Name</th>
                    <th>Company</th>
                    <th>Phone Number</th>
                    <th>Email</th>
                    <th>Assigned</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in tickets %}
                <tr>
                    <td>#{{ forloop.counter }}</td>
                    <td>{{ ticket.name }}</td>
                    <td>{{ ticket.company }}</td> <!-- Replace if company info exists -->
                    <td>{{ ticket.contact }}</td>
                    <td>{{ ticket.email }}</td>
                    <td>{{ ticket.assign_ticket }}</td>
                    <td>{{ ticket.status }}</td>
                    <td>
                        <button class="edit-btn" onclick="location.href='{% url 'edit_ticket' ticket.id %}'">
                            <img src="{% static 'images/edit (1) 2.png' %}"  style="width: 20px; height: 20px;text-decoration: none;">
              </a>
                        </button>

                        <form method="post" action="{% url 'delete' ticket.id %}" id="delete-form-{{ ticket.id }}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="delete-btn" onclick="confirmDelete({{ ticket.id }})">
                            <img src="{% static 'images/trash-2 2.png' %}"  style="width: 20px; height: 20px;text-decoration: none;">
              </a>
                        </button>
                        </form>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8">No tickets found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination">
          <span class="step-links">
            {% if tickets.has_previous %}
              <a href="?page=1">&laquo; First</a>
              <a href="?page={{ tickets.previous_page_number }}">Previous</a>
            {% endif %}
        
            <span class="current">
              Page {{ tickets.number }} of {{ tickets.paginator.num_pages }}.
            </span>
        
            {% if tickets.has_next %}
              <a href="?page={{ tickets.next_page_number }}">Next</a>
              <a href="?page={{ tickets.paginator.num_pages }}">Last &raquo;</a>
            {% endif %}
          </span>
        </div>
    </div>

</div>

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const graphButton = document.getElementById('graph-button');
        const graphSection = document.getElementById('graph-section');
        const tableSection = document.querySelector('.table-section');

        // Initially, the graph section is hidden
        graphSection.style.display = 'none';

        // Toggle visibility between Table and Graph
        graphButton.addEventListener('click', () => {
            // Toggle the visibility of the graph section and the table
            const isGraphVisible = graphSection.style.display === 'block';
            if (isGraphVisible) {
                graphSection.style.display = 'none';
                tableSection.style.display = 'block';
            } else {
                graphSection.style.display = 'block';
                tableSection.style.display = 'block';
                renderChart();  // Render the chart when graph section is shown
            }
        });

        // Function to render the chart
        function renderChart() {
            const ctx = document.getElementById('ticket-chart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Open', 'In Progress', 'On Hold', 'Answered', 'Closed'],
                    datasets: [{
                        label: 'Tickets Overview',
                        data: [
                            {{ ticket_counts.open }},
                            {{ ticket_counts.in_progress }},
                            {{ ticket_counts.on_hold }},
                            {{ ticket_counts.answered }},
                            {{ ticket_counts.closed }}
                        ],
                        backgroundColor: [
                            '#DFFFEA',
                            '#E7F3FF',
                            '#F4F4F4',
                            '#DFF9FF',
                            '#FFE7E7'
                        ],
                        borderColor: [
                            '#6AC995',
                            '#4A90E2',
                            '#B0B0B0',
                            '#00BFFF',
                            '#FF6F6F'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    });
</script>
<script>
    function confirmDelete(ticketId) {
        event.preventDefault();
        if (confirm('Are you sure you want to delete this ticket?')) {
            document.getElementById('delete-form-' + ticketId).submit();
        }
    }
    </script>
{% endblock %}
{% endblock %}
